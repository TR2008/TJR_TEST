<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Finalizar Compra - HVACsolution81</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fafafa; margin:0; padding:20px; }
    .container { max-width:800px; margin:0 auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    h1 { color:#003366; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
    .row { display:flex; gap:12px; }
    .col { flex:1; }
    button { margin-top:18px; padding:12px 18px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .basket-summary { background:#f7f7f7; padding:12px; border-radius:6px; margin-top:12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Finalizar Compra / Dados do Cliente</h1>

    <div class="basket-summary" id="basket-summary">
      <!-- Aqui mostramos resumo do cesto via JS ao carregar -->
      <strong>Resumo do Cesto:</strong>
      <ul id="basket-items"></ul>
      <p>Total: <span id="basket-total">0.00 €</span></p>
    </div>

    <form id="checkout-form" method="POST" action="/checkout">
      <!-- CSRF token: se usar Flask-WTF inclua {{ form.hidden_tag() }} -->
      <label for="nome">Nome completo</label>
      <input id="nome" name="nome" required>

      <label for="email">E-mail</label>
      <input id="email" name="email" type="email" required>

      <div class="row">
        <div class="col">
          <label for="telefone">Telefone</label>
          <input id="telefone" name="telefone" type="tel">
        </div>
        <div class="col">
          <label for="nif">NIF</label>
          <input id="nif" name="nif" required>
        </div>
      </div>

      <label for="morada">Morada completa</label>
      <textarea id="morada" name="morada" rows="2" required></textarea>

      <label for="aniversario">Data de nascimento</label>
      <input id="aniversario" name="aniversario" type="date">

      <input type="hidden" name="basket_snapshot" id="basket_snapshot">

      <button type="submit">Enviar e Gerar Ordem de Serviço</button>
    </form>
  </div>

  <script>
    // Carregar o cesto (usando endpoint existente /api/basket)
    async function loadBasket() {
      const resp = await fetch('/api/basket');
      if (!resp.ok) return;
      const data = await resp.json();
      const list = document.getElementById('basket-items');
      list.innerHTML = '';
      for (const id in data.basket) {
        const item = data.basket[id];
        const li = document.createElement('li');
        li.textContent = `${item.name} x${item.quantity} — ${(item.price * item.quantity).toFixed(2)} €`;
        list.appendChild(li);
      }
      document.getElementById('basket-total').textContent = data.summary.total.toFixed(2) + ' €';
      // guardar snapshot em campo oculto para enviar ao servidor
      document.getElementById('basket_snapshot').value = JSON.stringify(data);
    }

    document.addEventListener('DOMContentLoaded', loadBasket);
  </script>
</body>
</html>